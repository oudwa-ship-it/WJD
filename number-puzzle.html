<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4×4 數字華容道</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      margin:0;
      background-color:#f0f0f0;
      flex-direction:column;
    }
    h1{ margin-bottom: 16px; }
    #game-container{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
    }
    #game-board{
      width:400px;
      height:400px;
      border:2px solid #333;
      position:relative;
      background-color:#eee;
      user-select:none;
      touch-action: manipulation;
    }
    .tile{
      position:absolute;
      box-sizing:border-box;
      border:1px solid #000;
      cursor:pointer;
      transition: all 0.15s ease;
      background-color:#4CAF50;
      color:white;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:28px;
      font-weight:bold;
      border-radius:10px;
    }
    .tile:hover{ transform: scale(1.02); }
    .tile:active{ transform: scale(0.99); }

    /* 空白格不顯示 */
    .empty{
      display:none;
      cursor:default;
    }

    #info-panel{
      font-size:20px;
    }
    #reset-button{
      padding:10px 20px;
      font-size:18px;
      cursor:pointer;
    }
    #win-message{
      display:none;
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background-color:rgba(0,0,0,0.75);
      color:white;
      padding:20px 24px;
      border-radius:12px;
      font-size:26px;
      text-align:center;
      line-height:1.3;
    }
    #hint{
      font-size:14px;
      opacity:0.8;
      max-width: 420px;
      text-align:center;
    }
  </style>
</head>
<body>

<h1>數字華容道 4×4</h1>

<div id="game-container">
  <div id="game-board">
    <div id="win-message">恭喜！<br>你完成了！</div>
  </div>

  <div id="info-panel">
    步數: <span id="move-count">0</span>
  </div>

  <button id="reset-button">重新開始（打亂）</button>
  <div id="hint">玩法：點擊「和空白格相鄰」的數字方塊即可移動。</div>
</div>

<script>
  const gameBoard = document.getElementById('game-board');
  const moveCountSpan = document.getElementById('move-count');
  const resetButton = document.getElementById('reset-button');
  const winMessage = document.getElementById('win-message');

  const size = 4;               // 4x4
  const unitSize = 100;         // 每格 100px，所以棋盤 400x400
  const total = size * size;    // 16
  const EMPTY = 0;              // 用 0 代表空白格

  let moveCount = 0;
  let tiles = [];               // DOM tiles (包含空白格，但空白會 display:none)
  let board = [];               // 數字陣列，長度16，例如 [1,2,3,...,15,0]

  function indexToXY(i){
    return { x: i % size, y: Math.floor(i / size) };
  }

  function xyToIndex(x,y){
    return y * size + x;
  }

  function render(){
    // 依 board 重新定位每個 tile
    for (let i = 0; i < total; i++){
      const val = board[i];
      const tile = tiles[val]; // 以數字當索引：tiles[1] 是「1」的 tile，tiles[0] 是空白 tile
      const { x, y } = indexToXY(i);
      tile.style.left = `${x * unitSize}px`;
      tile.style.top  = `${y * unitSize}px`;
      tile.dataset.x = x;
      tile.dataset.y = y;
    }
  }

  function isSolved(){
    // 1..15,0
    for (let i = 0; i < total - 1; i++){
      if (board[i] !== i + 1) return false;
    }
    return board[total - 1] === EMPTY;
  }

  function showWin(show){
    winMessage.style.display = show ? 'block' : 'none';
  }

  function resetMoveCount(){
    moveCount = 0;
    moveCountSpan.textContent = moveCount;
  }

  function swapIndices(i, j){
    const tmp = board[i];
    board[i] = board[j];
    board[j] = tmp;
  }

  function getEmptyIndex(){
    return board.indexOf(EMPTY);
  }

  function canMove(val){
    if (val === EMPTY) return false;
    const valIndex = board.indexOf(val);
    const emptyIndex = getEmptyIndex();

    const a = indexToXY(valIndex);
    const b = indexToXY(emptyIndex);
    const manhattan = Math.abs(a.x - b.x) + Math.abs(a.y - b.y);
    return manhattan === 1; // 必須相鄰
  }

  function moveTile(val){
    if (!canMove(val)) return;

    const valIndex = board.indexOf(val);
    const emptyIndex = getEmptyIndex();
    swapIndices(valIndex, emptyIndex);

    moveCount++;
    moveCountSpan.textContent = moveCount;

    render();

    if (isSolved()){
      showWin(true);
    }
  }

  // --------- 產生「一定可解」的打亂 ---------
  // 判斷 4x4 是否可解：
  // 1) 計算 inversion（反序數）
  // 2) 找空白格從底部算第幾列（1~4）
  // 規則（size=4為偶數）：
  //   - 空白在「底部第奇數列」時，inversions 必須是偶數
  //   - 空白在「底部第偶數列」時，inversions 必須是奇數
  function inversionCount(arr){
    const nums = arr.filter(v => v !== EMPTY);
    let inv = 0;
    for (let i = 0; i < nums.length; i++){
      for (let j = i + 1; j < nums.length; j++){
        if (nums[i] > nums[j]) inv++;
      }
    }
    return inv;
  }

  function blankRowFromBottom(arr){
    const emptyIndex = arr.indexOf(EMPTY);
    const rowFromTop = Math.floor(emptyIndex / size); // 0..3
    return size - rowFromTop; // 4..1
  }

  function isSolvable(arr){
    const inv = inversionCount(arr);
    const blankFromBottom = blankRowFromBottom(arr);

    // size=4（偶數）
    if (blankFromBottom % 2 === 1){
      // 空白在底部第奇數列 -> inversions 偶數
      return inv % 2 === 0;
    } else {
      // 空白在底部第偶數列 -> inversions 奇數
      return inv % 2 === 1;
    }
  }

  function shuffleSolvable(){
    const arr = [];
    for (let i = 1; i <= total - 1; i++) arr.push(i);
    arr.push(EMPTY);

    // Fisher-Yates shuffle until solvable and not already solved
    do {
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        const t = arr[i]; arr[i] = arr[j]; arr[j] = t;
      }
    } while (!isSolvable(arr) || (arr.every((v, i) => v === (i === total-1 ? 0 : i+1))));

    return arr;
  }

  // --------- 建立棋子 ---------
  function createTiles(){
    gameBoard.querySelectorAll('.tile').forEach(e => e.remove());
    tiles = new Array(total);

    // 建立 0..15 的 tile（0 是空白）
    for (let val = 0; val < total; val++){
      const tile = document.createElement('div');
      tile.className = 'tile' + (val === EMPTY ? ' empty' : '');
      tile.textContent = (val === EMPTY) ? '' : String(val);
      tile.style.width = `${unitSize}px`;
      tile.style.height = `${unitSize}px`;

      tile.addEventListener('click', () => moveTile(val));

      tiles[val] = tile;
      gameBoard.appendChild(tile);
    }
  }

  function resetGame(){
    showWin(false);
    resetMoveCount();
    board = shuffleSolvable();
    createTiles();
    render();
  }

  resetButton.addEventListener('click', resetGame);

  // 初始化
  resetGame();
</script>

</body>
</html>
